name: release

on:
  schedule:
    # daily at 23:00 UTC
    - cron: 0 23 * * *
  workflow_dispatch:
  pull_request:

jobs:
  build:
    uses: ./.github/workflows/build.yml

  release:
    name: Publish a release
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Get release info
        id: info
        uses: shishifubing/ci-actions-common/actions/release-info@48ce595debac2eb5f2fb18ed3e86ea01f1ea23ca # v0.6.5
        env:
          GH_TOKEN: ${{ github.token }}
          
      - name: Download artifacts
        uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a # v3.0.2
        with:
          path: _release

      - name: Create a release
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v0.1.15
        if: steps.info.outputs.create == 'true'
        with:
          # events triggered by GitHub Actions don't trigger GitHub Actions, so
          # you need to pass custom token to trigger changelog workflow
          token: ${{ secrets.CI_GITHUB_TOKEN }}
          tag_name: ${{ steps.info.outputs.version }}
          name: ${{ steps.info.outputs.name }}
          body: ${{ steps.info.outputs.body }}
          files: _release/**/*
          draft: true
